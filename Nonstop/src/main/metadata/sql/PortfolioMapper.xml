<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="PortfolioMapper">
 	
 	
	<resultMap id="portfolioSelectMap" type="portfolio">
		<result property="portNo" 			column="port_no" 				jdbcType="NUMERIC"/>
		<result property="portUserId"		column="port_user_id" 			jdbcType="VARCHAR" />
		<result property="portDivision" 	column="port_division" 			jdbcType="NUMERIC" />
		<result property="portTitle" 		column="port_title" 			jdbcType="VARCHAR" />
		<result property="portRegdate" 		column="port_regdate" 			jdbcType="DATE" />
		<result property="portUpdate" 		column="port_update" 			jdbcType="DATE" />
		<result property="portFile" 		column="port_file" 				jdbcType="VARCHAR" />
		<result property="portDetail" 		column="port_detail" 			jdbcType="VARCHAR"  />
		<result property="totalPortView" 	column="port_viewcount" 		jdbcType="NUMERIC" />
		<result property="scrapUserId"		column="user_id"				jdbcType="VARCHAR"/>
		<result property="scrapNo"			column="scrap_no"				jdbcType="NUMERIC"/>

	</resultMap>
	
	 <resultMap id="commentSelectMap" type="portComment">
		<result property="comNo" 			column="com_no" 				jdbcType="INTEGER"/>
		<result property="comPortNo" 		column="com_port_no" 			jdbcType="INTEGER" />
		<result property="comUserId" 		column="com_user_id" 			jdbcType="VARCHAR" />
		<result property="comUserImg" 		column="user_img" 				jdbcType="VARCHAR" />
		<result property="comRegDate" 		column="com_port_regdate" 		jdbcType="DATE" />
		<result property="comContent" 		column="com_port_content" 		jdbcType="VARCHAR" />
		
	</resultMap>
	
	<!-- SQL : INSERT -->
	<insert 	id="addPortfolio"		parameterType="portfolio" >
	 	INSERT 
		INTO portfolio ( port_no, port_user_id, port_division, port_title, port_regdate, port_file, port_detail) 
		VALUES ( seq_portfolio_port_no.nextval, 
		#{portUserId}, 
		#{portDivision}, 
		#{portTitle}, 
		SYSDATE, 
		#{portFile}, 
		#{portDetail})
	 </insert>
	 
	 <!-- SQL : SELECT ONE -->
	 <select 	id="getPortfolio"	parameterType="map"	resultMap="portfolioSelectMap">
		<!-- SELECT
		port_no, port_user_id, port_division, port_title, port_regdate, port_update, port_file, port_detail, port_viewcount	
		FROM portfolio
		WHERE port_no = #{portNo} -->
		
		
		SELECT P.port_no, p.port_user_id, p.port_division, p.port_title, p.port_regdate, p.port_update, p.port_file, p.port_detail, p.port_viewcount,a.scrap_no
		FROM portfolio p,(SELECT scrap_no,port_no
     		  			  FROM scrap
     		  		 	  WHERE user_id=#{scrapUserId}) a
		WHERE p.port_no=a.port_no(+) AND p.port_no=#{portNo}
	 </select>

	 <select  id="getPortfolioList" parameterType="map" resultMap="portfolioSelectMap">
	  	SELECT p.port_no, p.port_user_id, p.port_division, p.port_title, p.port_regdate, p.port_update, p.port_file, p.port_viewcount ,a.scrap_no
     	FROM portfolio p, (select * from scrap where user_id=#{scrapUserId}) a
     <where>
        p.port_no=a.port_no(+) AND
        <if test="portDivision == 1">
         p.port_division IN (10,11,12)   
      </if>   
      <if test="portDivision == 2">
         p.port_division IN (20,21,22)   
      </if>
      <if test="portDivision != 1 and portDivision != 2">
         p.port_division = #{portDivision}
      </if>   
     </where>
	  	ORDER BY port_viewcount
	  	
	  	<!-- SELECT *
	  	FROM (	SELECT inner_table.* , ROWNUM AS row_seq
	  					FROM		(	SELECT p.prod_no , p.prod_name , p.prod_detail , p.manufacture_day , p.price , p.image_file , p.reg_date , NVL(t.tran_status_code,'0') tran_status_code
											FROM product p, transaction t
											<where>
											p.prod_no = t.prod_no(+)
												<if test="searchCondition != null">			
													<if test="searchCondition == 0 and searchKeyword !='' ">
										 				AND p.prod_no = #{searchKeyword}
													</if>
													<if test="searchCondition == 1 and searchKeyword !='' ">
										 				AND p.prod_name = #{searchKeyword}LIKE %#{SearchKeyword}%
													</if>
													<if test="searchCondition == 2 and searchKeyword !='' ">
										 				AND p.price = #{searchKeyword}
													</if>
												</if>
											</where>
											
											ORDER BY prod_no ) inner_table
						WHERE ROWNUM &lt;= #{endRowNum} )
		WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum} -->
	 </select>
	 
	<!-- SQL : INSERT -->
	<update 	id="updatePortfolio"		parameterType="portfolio" >
	 	UPDATE portfolio
		<set>
		port_division=#{portDivision}, 
		port_title=#{portTitle},
		<if test="portViewFlag == true">
			port_viewcount=#{totalPortView},	
		</if>	
		<if test="portViewFlag == false">	 
			port_update=SYSDATE,
		</if> 
		port_file=#{portFile}, 
		port_detail=#{portDetail}
		</set>
		WHERE port_no=#{portNo}
	</update>
	
	<insert 	id="addComment"		parameterType="portComment" >
	 	INSERT INTO 
	 	port_comment( com_no , com_port_no , com_user_id , com_port_regdate , com_port_content) 
		VALUES	 (	seq_port_comment_com_no.nextVal, 
		#{comPortNo}, 
		#{comUserId}, 
		SYSDATE, 
		#{comContent})
		<selectKey keyProperty="comNo" resultType="Integer" order="AFTER">
        SELECT seq_port_comment_com_no.currval FROM dual
    	</selectKey>
	 </insert>
	 
	<select  id="getComment"  parameterType="int"	resultMap="commentSelectMap">
		SELECT c.com_no, c.com_port_no, c.com_user_id, c.com_port_regdate, c.com_port_content, u.user_id, u.user_img
		FROM port_comment c, users u 
		WHERE c.com_no = #{comNo} 
		AND u.user_id = c.com_user_id
	</select>
	 
 

	<delete id="deleteComment" parameterType="int">
		DELETE from port_comment
		where com_no = #{value}
	</delete>
	 
	 
	<select  id="getCommentList"  parameterType="int"	resultMap="commentSelectMap">

		SELECT c.com_no, c.com_port_no, c.com_user_id, c.com_port_regdate, c.com_port_content, u.user_id, u.user_img
		FROM port_comment c, users u 
		WHERE c.com_port_no = #{comPortNo} 
		AND u.user_id = c.com_user_id
		ORDER BY com_port_regdate DESC
		
	</select>
	
	
	 
</mapper>